# 한경 컨센서스 상향 내역 수집 & 분야 시각화
- 목표 : 보고서 내용 배제 & 상향 보고서가 나온 기업 및 분야를 웹 스크래핑 & 시각화
    - 아이디어 : 어떤 분야의 기업들에 대한 상향 전망이 나온다 -> 해당 산업이 흥한다고 볼 수 있지 않을까?
    - 데이터 수집 : 웹 스크래핑(`requests`, `bs4`, `selenium`)
        - 편의상 데이터 수집은 `2022년 5월 1일`부터 수집하고 하루 단위로 갱신 (사이트에 과한 부하를 주지 않게 하기 위해 일부 데이터만 받음)
    - 수집한 데이터는 `SQL`을 이용하여 저장 & 조회 : 테이블 2개 (`reports`, `companies`)
        - `reports` : `id(pk)`, `회사명`, `보고서 올라온 날짜`, `작성 증권사`
        - `companies` : `회사명(pk)`, `회사코드`, `카테고리`
    - 시각화는 그냥 간단하게 막대그래프로 조회가 될 듯
        - 조회할 때 같은 기업이 여러 번 조회되는 경우도 있을 것이니 보고서 수와 기업 수는 별도로 생각해야 함

# 해야 할 일
- 데이터 수집 파일 자동화
    - 마지막으로 실행된 날짜를 기억, 그 다음 날부터 파일을 실행하는 지금까지의 날짜를 url에 넣어주기만 하면 될 듯
    - 매일 자동으로 실행되게 해도 괜찮을 것 같음. 위 아이디어랑 섞어서 구현할 수 있을 것 같다

- DBMS의 데이터를 파이썬에 올리고 시각화하는 과정 : `pandas`와 `matplotlib`, `seaborn`을 이용하게 될 듯?

# 일자별 진행 과정 
- 진행 기간 : `220803 ~ `

## 220805
1. `DataCollect.ipynb`
    - 정규 표현식 수정(`Greedy -> Reluctant`)
    - 함수 인풋 값 str() 수정
    - 정상적으로 수집되지 않는 데이터 수정, 원인 모를 공란 예외처리 완료
    - `reports` 테이블에 회사명이 중복해서 들어가지 않는 현상 수정 완료
2. `DataProcessing.ipynb`
    - SQL에 쿼리를 날려서 판다스로 옮기는 코드만 작성해둠
    
## 220804
1. `DataCollect.ipynb`
    - `get_category` 함수 정의(코드를 인풋으로 받아 네이버 증권에서 산업 분야 정보를 가져옴)
2. MySQL 설치 & 데이터베이스 생성 & 테이블 생성
    - 테이블을 2개를 만듦.
        1. id(pk), 기업이름(fk), 보고서가 올라온 날짜, 보고서를 올린 증권사
        2. 기업이름(pk), 코드(uk), 분야
    - 데이터를 집어넣지 않음 : `db.commit()` 하고 `db.close()`하면 되긴 하는데, 일단은 진행하지 않았음(좀 살펴봐야 할 것 같아서)

## 220803
1. `DataCollect.ipynb` : 한경 컨센서스에서 제목 가공 & 4가지 변수로 나눠 저장했음


# 시행착오

## 220805
1. `InterFaceError(0, '')` : db와 연결된 상태에서 에러 발생 시 Connection이 계속 연결되어 있는 상태가 됨
    - 해결법 : `try` ~ `finally` 블럭을 이용해 항상 Connection을 close해주는 것
        - `except` 는 오류 발생 시 처리되는 코드라면
        - `finally` 는 오류 발생에 관계없이 처리되는 코드 라인임. 
        - `try` 내의 반복문을 돌다가 오류가 발생하면 `except`로 빠져나가게 됨. `finally`가 있다면 그대로 `finally`로 빠져나감
    - 추가로 각 쿼리마다 커서가 1번만 동작하게끔 `with`문을 이용하는 것도 좋다.
    - `Cursor` 개념부터 잡고 가자
        - 1개의 DB Connection에 대해 독립적으로 SQL문을 실행할 수 있는 작업환경을 제공하는 객체 
        - `한 connection에 한 cursor만 실행 가능`함

2. `reports`에 같은 회사명이 중복해서 들어가지 않는 현상
    - `companies`에 먼저 데이터를 넣기 때문에 발생하는 오류 : 예외처리문으로 빠져나가면 다음 반복문으로 그냥 넘어가버림
    - 데이터를 넣는 순서를 `reports` -> `companies` 순으로 바꿔줬음

## 220804
1. `MySQL` : 테이블의 데이터 타입을 바꿀 필요가 있어서 `ALTER TABLE (테이블명) MODIFY (칼럼명) (바꿀 데이터타입)`을 눌렀는데 렉 걸림
    - 그냥 테이블을 지웠다가 다시 만들기로. 어차피 비어 있으니까!

## 220803
1. VS code의 주피터 노트북 가상환경 설정하기
    - `.py` 파일과 달리 `.ipynb`는 가상환경에 자동으로 연결되지 않음
    - 가상환경을 만듦 -> `.ipynb` 파일 생성 -> `우측 상단 커널 가상환경으로 세팅`하면 끝임

2. 한경 컨센서스의 컨센서스 항목이 로그인을 요하게 됨 - [예전 사이트](http://hkconsensus.hankyung.com/apps.analysis/analysis.list?skinType=stock_good&sdate=2022-05-03&edate=2022-08-03&order_type=&now_page=1) 있어서 그걸로 하면 될 듯
    - `requests`로 접근하려 했으나, `form`이 없고 자바스크립트에 적힌 `login/ajaxActionLogin.do`로 접근해봤는데 먹히지 않음
    - 그래서 `Selenium`으로 시도해봄
    
3. 정규표현식 : 괄호 앞까지만 탐색 : `.+(?=\()` : `(?=)` 부분이 전방 탐색 부분이다 : `(?=`와 `)` 사이에 들어가는 문자 전까지 매치해줌
    - 즉 `탐색하고 싶은 문자 정규표현식``(?=[경계문자])` 으로 쓰면 된다.
