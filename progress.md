# 한경 컨센서스 상향 내역 수집 & 분야 시각화
- 목표 : 보고서 내용 배제 & 상향 보고서가 나온 기업 및 분야를 웹 스크래핑 & 시각화
    - 아이디어 : 어떤 분야의 기업들에 대한 상향 전망이 나온다 -> 해당 산업이 흥한다고 볼 수 있지 않을까?(커뮤니티에서 본 아이디어)
    - 데이터 수집 : 웹 스크래핑(`requests`, `bs4`, `selenium`)
        - 원래는 `22년 5월 1일`부터 수집하려고 했는데, 수집하는 데이터의 양이 매우 적은 것 같아서 `22년 1월 1일`부터 수집하겠음
        - [수집 사이트](http://hkconsensus.hankyung.com/apps.analysis/analysis.list?&skinType=stock_good)
    - 수집한 데이터는 `SQL`을 이용하여 저장 & 조회 : 테이블 2개 (`reports`, `companies`)
        - `reports` : `id(pk)`, `회사명`, `보고서 올라온 날짜`, `작성 증권사`
        - `companies` : `회사명(pk)`, `회사코드`, `카테고리`
    - 시각화는 그냥 간단하게 막대그래프로 조회할 수 있을 듯
        - 조회할 때 같은 기업이 여러 번 조회되는 경우도 있을 것이니 보고서 수와 기업 수는 별도로 생각해야 함

# 해야 할 일
1. SQL에서 데이터를 가져올 때 기업 테이블과 레포트 테이블을 지금처럼 분리할 것인지 아니면 이어놓은 채로 유지시킬 것인지
2. 레포트 링크가 제대로 걸리지 않는 것 같음. 체크해보자
3. 해당 기업에 대한 링크도 저장해두자. : 네이버 사이트를 이용? - 코드로 들어갈 수 있을 것 같음
4. 조금 더 나아간다면 상위 산업 몇 개를 추린다 -> 그 산업을 조회하면 기업들 이름이 쫙 있을 것 -> 그 기업들의 이름과 상향 보고서가 나온 날짜를 나열해주는 거까지 한꺼번에 구현할 수 있을 것이다
    - 예를 들어 보고서가 나온 순서대로 상위 5개 산업 -> 그 산업에 있는 기업과 각 기업의 상향 보고서 수 시각화 까지 구현해보는 거다
    - 이런 일련의 과정을 그래프의 막대를 클릭하면 그 산업에 대한 기업들의 상향 보고서 수를 쭉 보여주는 식으로 구현하면 좋겠지만 그런 인터페이스 관련한 지식이 없긴 하다. 애초에 웹을 구현해야 할 것 같음
5. 뭔가 더 할 수 있을 것 같은데 생각나는 게 없으면 1~4를 하고 마감해야지 뭐..


# 일자별 진행 과정 
- 진행 기간 : `220803 ~ `

## 220808
1. DB 접속 username, passwd, 데이터베이스 이름 저장 파일 별도 분리(`sql_info.py`) (`.gitignore`에 추가)
2. 데이터 다시 수집 : `22년 1월 1일`부터 수집, `reports` 테이블에 각 보고서의 인덱스(사이트)를 추가
    - 데이터 수집 시 페이지 수를 얻고 시작하도록 수정
3. 간단한 조회 구현 : 데이터 조회는 `주` 단위로 가능함


## 220806
1. `DataCollect.ipynb` -> `DataCollect.py`(자동 실행)
    - 1. 앞에서 구현했던 것들 함수화 & 첫날짜 지정 함수를 새로 만듬
        - SQL에 조회 쿼리를 날렸을 때 데이터가 없다면(`IndexError`) `2022-05-01`부터 탐색,
        - 데이터가 있다면 내림차순해서 나온 날짜 다음날부터 탐색을 시작함
        - 여기서 탐색하는 것과, 올라온 보고서가 실제로 있는지 없는지 여부는 별개
    - 2. 자동 실행 구현 & `DataCollect.py`로 파이썬 파일로 만들어놓음
        - `schedule`로 매일 20시에 함수가 실행되게 함 & 윈도우 작업 스케줄러 연동[참고](https://wikidocs.net/5857)
        - 윈도우의 작업 스케줄러 기능을 이용하면 굳이 `schedule`을 구현할 필요는 없어 보이긴 하는데, 나중에 서버에 올릴 수도 있으니까
        만들어는 뒀다. 

## 220805
1. `DataCollect.ipynb`
    - 정규 표현식 수정(`Greedy -> Reluctant`)
    - 함수 인풋 값 `str()` 수정
    - 정상적으로 수집되지 않는 데이터 수정, 원인 모를 공란 예외처리 완료
    - `reports` 테이블에 회사명이 중복해서 들어가지 않는 현상 수정 완료
2. `DataProcessing.ipynb`
    - SQL에 쿼리를 날려서 판다스로 옮기는 코드만 작성해둠
    
## 220804
1. `DataCollect.ipynb`
    - `get_category` 함수 정의(코드를 인풋으로 받아 네이버 증권에서 산업 분야 정보를 가져옴)
2. MySQL 설치 & 데이터베이스 생성 & 테이블 생성
    - 테이블을 2개를 만듦.
        1. id(pk), 기업이름(fk), 보고서가 올라온 날짜, 보고서를 올린 증권사
        2. 기업이름(pk), 코드(uk), 분야
    - 데이터를 집어넣지 않음 : `db.commit()` 하고 `db.close()`하면 되긴 하는데, 일단은 진행하지 않았음(좀 살펴봐야 할 것 같아서)

## 220803
1. `DataCollect.ipynb` : 한경 컨센서스에서 제목 가공 & 4가지 변수로 나눠 저장했음


# 시행착오

## 220808
1. `reports` 테이블에 보고서의 링크 추가하기 [스택오버플로우](https://stackoverflow.com/questions/6404628/varchar-vs-text-in-mysql)
    - `MYSQL(5.0.3)` 이상의 버전은 `VARCHAR`의 최대 저장 바이트수가 `255` -> `65535`로 증가했기 떄문에 
        - 하이퍼링크를 걸고 싶다면 `VARCHAR(20000)`으로 지정하면 ㅇㅋ
        - 오류 뜸 : 최댓값은 `16383`이라고 한다.
    - 이전엔 `TEXT`를 썼다고 하는데 이건 테이블 밖에 저장된다는 말이 있다.
    - 테이블 바꾸기 : `ALTER TABLE 테이블명 ADD 컬럼명 자료형`
        - 맨 앞에 추가하고 싶다면 `자료형` 뒤에 `FIRST`를 붙이고
        - 어떤 컬럼 다음에 추가하고 싶다면 `자료형` 뒤에 `AFTER 앞컬럼명`을 붙이면 됨
    - 저장을 어떻게 할 지가 고민 : 링크 전체를 긁어서 저장하는 방법과, 보고서의 인덱스만 저장하는 방법이 있음
        - 보고서를 조회할 때 저장되어 있는 인덱스 + 공통된 형식만 연결지으면 되긴 함. 
    - <b>결과적으로 1.은 링크를 저장하지 않고 각 보고서의 고유값만 저장했다.</b>
2. 정규표현식 - 후방탐색 : `(?<={탐색하려는 경계:포함되지 않는 값})찾고자 하는 값`
3. SQL 날짜 조회는 DATE 타입의 칼럼에 등호를 넣으면 됨, 그 등호는 `date >= '2022-06-30'` 같이 작은 따옴표를 쳐준다 
4. `timedelta`는 `weeks=`까지만 가능하다. 개월 단위는 없음.
5. `groupby`는 어떤 통계적 수치를 이용하고 싶을 때 사용하면 된다.
    - 기본적인 조회는 그냥 `df[df[...] == ...]`의 조건문을 이용하면 됨!
6. `value_counts`를 `seaborn`에서 시각화하기
    - `sns.countplot`으로 간단하게 이용할 수 있다(조건을 주긴 힘든 듯?)

## 220806
1. 판다스에서 SQL 긁어왔을 때 datetime 객체가 유지되는 걸 확인할 수 있었다. (당연히 str로 긁어올 줄 알았다.)
    - 혹시 str로 긁어오는 케이스가 있다면 `datetime.datetime.strptime('%Y-%m-%d')`를 이용해주면 된다

2. `datetime.today().weekdays()` : `0~4` : 월~금 / `5, 6` : 토, 일

## 220805
1. `InterFaceError(0, '')` : db와 연결된 상태에서 에러 발생 시 Connection이 계속 연결되어 있는 상태가 됨
    - 해결법 : `try` ~ `finally` 블럭을 이용해 항상 Connection을 close해주는 것
        - `except` 는 오류 발생 시 처리되는 코드라면
        - `finally` 는 오류 발생에 관계없이 처리되는 코드 라인임. 
        - `try` 내의 반복문을 돌다가 오류가 발생하면 `except`로 빠져나가게 됨. `finally`가 있다면 그대로 `finally`로 빠져나감
    - 추가로 각 쿼리마다 커서가 1번만 동작하게끔 `with`문을 이용하는 것도 좋다.
    - `Cursor` 개념부터 잡고 가자
        - 1개의 DB Connection에 대해 독립적으로 SQL문을 실행할 수 있는 작업환경을 제공하는 객체 
        - `한 connection에 한 cursor만 실행 가능`함

2. `reports`에 같은 회사명이 중복해서 들어가지 않는 현상
    - `companies`에 먼저 데이터를 넣기 때문에 발생하는 오류 : 예외처리문으로 빠져나가면 다음 반복문으로 그냥 넘어가버림
    - 데이터를 넣는 순서를 `reports` -> `companies` 순으로 바꿔줬음

## 220804
1. `MySQL` : 테이블의 데이터 타입을 바꿀 필요가 있어서 `ALTER TABLE (테이블명) MODIFY (칼럼명) (바꿀 데이터타입)`을 눌렀는데 렉 걸림
    - 그냥 테이블을 지웠다가 다시 만들기로. 어차피 비어 있으니까!

## 220803
1. VS code의 주피터 노트북 가상환경 설정하기
    - `.py` 파일과 달리 `.ipynb`는 가상환경에 자동으로 연결되지 않음
    - 가상환경을 만듦 -> `.ipynb` 파일 생성 -> `우측 상단 커널 가상환경으로 세팅`하면 끝임

2. 한경 컨센서스의 컨센서스 항목이 로그인을 요하게 됨 - [예전 사이트](http://hkconsensus.hankyung.com/apps.analysis/analysis.list?skinType=stock_good&sdate=2022-05-03&edate=2022-08-03&order_type=&now_page=1) 있어서 그걸로 하면 될 듯
    - `requests`로 접근하려 했으나, `form`이 없고 자바스크립트에 적힌 `login/ajaxActionLogin.do`로 접근해봤는데 먹히지 않음
    - 그래서 `Selenium`으로 시도해봄
    
3. 정규표현식 : 괄호 앞까지만 탐색 : `.+(?=\()` : `(?=)` 부분이 전방 탐색 부분이다 : `(?=`와 `)` 사이에 들어가는 문자 전까지 매치해줌
    - 즉 `탐색하고 싶은 문자 정규표현식``(?=[경계문자])` 으로 쓰면 된다.
